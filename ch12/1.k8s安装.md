# 安装k8s

## 1.硬件配置
建议至少2 cpu ,2G，非硬性要求，1cpu，1G也可以搭建起集群。但是：

1个cpu的话初始化master的时候会报	[WARNING NumCPU]: the number of available CPUs 1 is less than the required 2
因为安装的东西太多了，内存太少可能不够。部署插件或者pod时可能会报warning：FailedScheduling：Insufficient cpu, Insufficient memory

## 2.安装docker
https://yeasy.gitbooks.io/docker_practice/content/install/centos.html

## 3.修改内核参数
禁用ipv6，否则会造成coredns容器无法启动
```
cat <<EOF >  /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward=1
EOF

sysctl --system
```

## 4.关闭swap
k8s1.8版本以后，要求关闭swap，否则默认配置下kubelet将无法启动
```
$  swapoff -a

#防止开机自动挂载 swap 分区
$  sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
```

## 5.关闭防火墙
k8s的Master与工作节点node之间会有大量的网络通信，正常做法是在防火墙配置开放需要通信的端口(在安全的内部网络环境中可以直接关闭防火墙)
```
systemctl stop firewalld
systemctl disable firewalld

//查看防火墙状态
firewall-cmd --state
```

## 6.关闭SELINUX
让容器可以读取主机文件系统
```
setenforce 0
或
sed -i 's/SELINUX=permissive/SELINUX=disabled/' /etc/sysconfig/selinux
```

## 7.安装 kubeadm, kubelet 和 kubectl
```
// 添加yum源
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

// 安装
yum install -y kubelet kubeadm kubectl kubernetes-cni

// 设置开机启动kubelet
systemctl enable kubelet
```

## 8.下载Kubernetes的相关镜像
```
// 查看需要用到的镜像
[root@will lib]# kubeadm config images list
k8s.gcr.io/kube-apiserver:v1.16.3
k8s.gcr.io/kube-controller-manager:v1.16.3
k8s.gcr.io/kube-scheduler:v1.16.3
k8s.gcr.io/kube-proxy:v1.16.3
k8s.gcr.io/pause:3.1
k8s.gcr.io/etcd:3.3.15-0
k8s.gcr.io/coredns:1.6.2
```

由于国内网络的条件，所以需要通过国内镜像仓库去拉取镜像
```
// 下载镜像：
// https://blog.csdn.net/educast/article/details/89675278
docker pull kubeimage/kube-apiserver-amd64:v1.16.3
docker pull kubeimage/kube-controller-manager-amd64:v1.16.3
docker pull kubeimage/kube-scheduler-amd64:v1.16.3
docker pull kubeimage/kube-proxy-amd64:v1.16.3
docker pull mirrorgooglecontainers/pause-amd64:3.1
docker pull mirrorgooglecontainers/etcd-amd64:3.3.15-0
docker pull coredns/coredns:1.6.2

// 修改镜像名称：
docker tag kubeimage/kube-apiserver-amd64:v1.16.3  k8s.gcr.io/kube-apiserver:v1.16.3
docker tag kubeimage/kube-controller-manager-amd64:v1.16.3 k8s.gcr.io/kube-controller-manager:v1.16.3
docker tag kubeimage/kube-scheduler-amd64:v1.16.3 k8s.gcr.io/kube-scheduler:v1.16.3
docker tag kubeimage/kube-proxy-amd64:v1.16.3 k8s.gcr.io/kube-proxy:v1.16.3
docker tag mirrorgooglecontainers/pause-amd64:3.1 k8s.gcr.io/pause:3.1
docker tag mirrorgooglecontainers/etcd-amd64:3.3.15-0 k8s.gcr.io/etcd:3.3.15-0
docker tag coredns/coredns:1.6.2 k8s.gcr.io/coredns:1.6.2

// 删除无用标签：
docker images | grep mirrorgooglecontainers | awk '{print "docker rmi "  $1":"$2}' | sh -x(部分系统不一样，手动删除即可)
```

```
// 查看准备好的镜像
[root@will lib]# docker images
REPOSITORY                           TAG                 IMAGE ID            CREATED             SIZE
k8s.gcr.io/kube-apiserver            v1.16.3             df60c7526a3d        6 days ago          217 MB
k8s.gcr.io/kube-proxy                v1.16.3             9b65a0f78b09        6 days ago          86.1 MB
k8s.gcr.io/kube-controller-manager   v1.16.3             bb16442bcd94        6 days ago          163 MB
k8s.gcr.io/kube-scheduler            v1.16.3             98fecf43a54f        6 days ago          87.3 MB
k8s.gcr.io/etcd                      3.3.15-0            b2756210eeab        2 months ago        247 MB
k8s.gcr.io/coredns                   1.6.2               bf261d157914        3 months ago        44.1 MB
k8s.gcr.io/pause                     3.1                 da86e6ba6ca1        23 months ago       742 kB
```

## 9.运行kubeadm init 命令安装Master
```
[root@will k8s]# kubeadm init --pod-network-cidr=192.168.0.0/16 --ignore-preflight-errors=NumCPU --kubernetes-version=1.16.3
[init] Using Kubernetes version: v1.16.3
...
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 10.5.24.100:6443 --token e1dw1f.8q0mzlvqh912jw61 \
    --discovery-token-ca-cert-hash sha256:1bfafefbede5b8ce4cdf9c36852476afb243e8f6d7cb3b22f5e5611653f728b8 
```

Kubernetes 集群默认需要加密方式访问。以下这几条命令，就是将刚刚部署生成的 Kubernetes 集群的安全配置文件，保存到当前用户的.kube 目录下，kubectl 默认会使用这个目录下的授权信息访问 Kubernetes 集群
```
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

// 查看节点
[root@will ~]# kubectl get nodes
NAME   STATUS     ROLES    AGE   VERSION
will   NotReady   master   41m   v1.16.3
// STATUS状态为NotReady(因为没有安装网络插件)
```

## 10.安装weave网络插件
```
kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=1.16.3"

// 验证pod是否正常运行(安装完需要等待2分钟)
[root@will ~]# kubectl get pods --all-namespaces
NAMESPACE     NAME                           READY   STATUS    RESTARTS   AGE
kube-system   coredns-5644d7b6d9-pk9xc       1/1     Running   0          13m
kube-system   coredns-5644d7b6d9-s6thk       1/1     Running   0          13m
kube-system   etcd-will                      1/1     Running   0          13m
kube-system   kube-apiserver-will            1/1     Running   0          12m
kube-system   kube-controller-manager-will   1/1     Running   0          13m
kube-system   kube-proxy-8mmtn               1/1     Running   0          13m
kube-system   kube-scheduler-will            1/1     Running   0          13m
kube-system   weave-net-kmx8s                2/2     Running   0          9m13s

// 如果发现有状态错误的Pod, 则可以执行kubectl --namespace=kube-system describe pod <pod_name>查看具体原因
```

## 11.开启单机模式
```
kubectl taint nodes --all node-role.kubernetes.io/master-
```

## 12.查看集群信息
```
kubectl cluster-info
```

## 12.安装过程中可能存在的异常
```
部分参考：https://www.jianshu.com/p/c92e46e193aa

[preflight] Some fatal errors occurred:
  [ERROR DirAvailable--var-lib-etcd]: /var/lib/etcd is not empty
直接删除/var/lib/etcd文件夹即可
```

## 13.参考资料
```
kubernetes权威指南
https://www.cnblogs.com/hongdada/p/9761336.html
https://blog.csdn.net/clouduncle/article/details/82750291
```